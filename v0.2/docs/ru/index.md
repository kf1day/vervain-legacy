# Оглавление

1. Описание
2. Настройка
   - bootstrap.php
   - Необходимые переменные сервера
3. Карта сайта
   - Файл sitemap.php

# Описание
Vervain – легковесный мульти-сайтовый MVC-фреймворк, который создавался в первую очередь для упрощенНого сопоставления набора URI с их обработчиками ([контроллерами](#ctrl)). Сопоставления описываются в виде дерева [паттернов](#pattern), описаном в файле [sitemap.php](#sitemap)

## Терминология
<a id="ctrl">**Контроллер**</a> – класс, которому передается генерация контента, исходя из [дерева паттернов](#sitemap). Класс должен находится в пространстве имен `action` и наследовать класс `\app\action`

<a id="seguri">**Сегмент URI**</a> (сегмент URI-пути) – часть пути URI, отделенная прямыми слешами, не включая сам разделитель. В запросе вида `/path/to/smth` сегментами URI считаются `path`, `to` и `smth`


# Настройка

## bootstrap.php
Движок vervain автоматически осуществляет разбор URI, все запросы к динамическому контенту необходимо передавать на обработку в файл
`bootstrap.php` 

***Пример конфигурации сайта для nginx***
```nginx
server {

	listen 80;
	server_name vervain-demo.domain.tld;

	root /var/www/vervain/sites/demo;

	location ~* \.php$ {
		return 404; 
	}

	location /static/ {
		try_files $uri =404;
		gzip_types *;
		expires 7d;
	}

	location / {
		try_files $uri @baduri;
	}
 
	location @baduri {
		fastcgi_param SCRIPT_FILENAME /var/www/vervain/v0.2/bootstrap.php;
		fastcgi_pass unix:/run/php/php7.0-fpm.sock;
		include fastcgi_params;
	}
}
```

Включаемый файл `fastcgi_params` из поставки `nginx`, как правило, уже содержит необходимые переменные для передачи PHP-процессору, но некоторые из них напрямую используются движком vervain, и на них следует обратить особое внимание

## Необходимые переменные сервера
**DOCUMENT_ROOT** – Корневая директория сайта, определенная сервером, служит для формирования путей для файлов конфигурации и пользовательских классов

**DOCUMENT_URI** – Путь для разбора парсером

**HTTPS [on|off]** и **REQUEST_SCHEME** – Служит для определения факта работы сайта по https (например, при построении redirect'ов). `REQUEST_SCHEME` при конфликтах имеет более высокий приоритет

# <a id="sitemap">Карта сайта</a>
Карта сайта сопоставляет все возможные URI сайта с контороллерами.
Сегменты URI описываются в файле `sitemap.php` с помощью древовидной структуры, начиная с одной корневой ноды.

## Формат ноды
Каждая нода содержит `паттерн`, `обработчик` и необязательный массив дочерних нод

```php
array( 'паттерн', 'обработчик' [, array( node1, node2, ... ) ] );
```

<a id="pattern">**Паттерн**</a> – определяет один или несколько сегментов URI, разделенных прямым слешем.
Символ `*` (звездочка) трактуется как любое значение сегмента \(далее: `маскированная локация`).
Паттерн для корневой ноды задает базовый URI для всего сайта.

***Примеры паттернов***
```
'/test/'
'elements/*'
'shop/*/detail'
```

<a id="action">**Обработчик**</a> – задает способ обработки подходящего паттерна в виде
```
[класс][@метод][/аргумент1][/аргумент2][/аргументN]
```
Любая из частей (включая все одновременно) может быть опущена.
Специальное значение `null` означает, что нода будет отмечена, как транзитная – при обращении к такой ноде парсер сформирует переход к первой не-транзитной дочерней ноде.
* `класс` определяет класс контроллера для передачи управления.
В случае пропуска наследуется от вышестоящей ноды.
При невозможности наследования, дальнейшая обработка будет остановлена с ошибкой 
* `метод` явно указывает используемый метод класса. В случае отсутствия метод определяется дальнейшим разбором URI
* `аргумент1..N` если заданы, будут переданы в метод перед аргументами, полученными при дальнейшем разборе URI

## Аспекты парсера
### Разбор URI
Парсер находит соответствие максимальной длины.
Первый "лишний" сегмент URI трактуется как название метода, остальльные - как аргументы.
Если метод в обработчике задан явно, первый сегмент так же является аргументом.

### Маскированные локации \(\*)
Парсер производит внутреннюю сортировку, сдвигая маскированную локацию вниз на текущем уровне вложенности.
Таким образом сначала будут перебраны явно заданные сегменты.
Это означает, что задавать явные и маскированные локации в паттернах можно в любом порядке.
Значение, определенное маскированной локацией всегда будет являться аргументом в методе контроллера

### Наследование и много-сегментные паттерны
Парсер разбивает много-сегментные паттерны на дерево одно-серментных, таким образом, что
```php
[ 'foo/bar/baz', 'some_action' ]
```
внутренне приводится к 
```php
[ 'foo', null, [
    [ 'bar', null, [
        [ 'baz', 'some_action' ],
    ]],
]]
```
Однако, наследование имени класса производится до разбиения, поэтому в случае
```php
[ '', 'root_class', [
    [ 'sub', 'sub_class' ],
    [ 'sub/foo', '@foo' ],
]]
```
`foo` унаследует класс `root_class`, который является родительским до анализа паттерна:
```php
[ '', 'root_class', [
    [ 'sub', 'sub_class', [
        [ 'foo', 'root_class@foo' ],
    ]],
]]
```

## <a id="sitemap">Файл sitemap.php</a>
Файл `sitemap.php` должен находится в корневой директории сайта и содержать возвращаемый массив, состоящий из дерева нод.

***Пример sitemap.php***
```php
return [ '', null, [				// 1
    [ 'mercury', 'class_mercury' ],		// 2
    [ 'venus', 'class_venus@overview' ],	// 3
    [ 'earth', 'class_earth', [			// 4
        [ 'countries', 'class_countries', [	// 5
	    [ '*/flag', '@flag/small' ],	// 6
	    [ '*/leader', '' ],			// 7
	    [ 'list', '@list' ],		// 8
	]],
    ]],
    [ 'mars', 'class_mars/missions' ],		// 9
]];
```

***Примеры запросов***

|URI|№ ноды|Обработчик
|---|---|---
|/mercury/|2|\action\class_mercury::index()
|/mercury/size/metric|2|\action\class_mercury::size('metric')
|/venus/size/metric|3|\action\class_venus::overview('size', 'metric')
|/earth/countries/list/|8|\action\class_countries::list()
|/earth/countries/tongo/flag|6|\action\class_countries::flag('small', 'tongo')
|/earth/countries/libya/leader/gaddafi|7|\action\class_countries::leader('libya', 'gaddafi')
|/mars/current/curiosity|9|\action\class_mars::current('missions', 'curiosity')


|URI|Перенаправление
|---|---
|/|/mercury/
|/earth/countries/tongo|/earth/countries/tongo/flag/
